import os
import geopandas as gpd
import requests


def download_geojson():
    url = os.getenv('REGION_DATA_URL')  # The SAS URL for the file
    if not url:
        raise ValueError("The REGION_DATA_URL environment variable is not set.")
    response = requests.get(url)
    response.raise_for_status()  # Ensure the request was successful
    os.makedirs('data', exist_ok=True)
    with open('data/Basisdata_Cleaned.geojson', 'wb') as f:
        f.write(response.content)


def load_geojson():
    data_path = 'data/Basisdata_Cleaned.geojson'

    if not os.path.exists(data_path):
        download_geojson()

    gdf = gpd.read_file(data_path)

    gdf = gdf.to_crs("EPSG:4326")

    return gdf

GDF = load_geojson()
spatial_index = GDF.sindex
API_KEY = os.getenv('POLLENVARSEL_API_KEY')
BASE_URL = "https://pollenvarsel.naaf.no/api"

norway_kommuner = {
        "Alta": "finnmark",
        "Hammerfest": "finnmark",
        "Kirkenes": "finnmark",
        "Askøy": "hordaland",
        "Brumunddal": "indreOstlandet",
        "Mo i Rana": "nordland",
        "Mosjøen": "nordland",
        "Sandnessjøen": "nordland",
        "Fredrikstad": "ostlandetMedOslo",
        "Hønefoss": "ostlandetMedOslo",
        "Ålgård": "rogaland",
        "Figgjo": "rogaland",
        "Bryne": "rogaland",
        "Egersund": "rogaland",
        "Kopervik": "rogaland",
        "Geilo": "sentraleFjellstrokISorNorge",
        "Hovden": "sentraleFjellstrokISorNorge",
        "Førde": "sognOgFjordande",
        "Arendal": "sorlandet",
        "Mandal": "sorlandet",
        "tromsø": "troms",
        "tromsdalen": "troms",
        # Additional kommuner:
        "Agdenes": "trondelag",
        "Alstahaug": "nordland",
        "Alvdal": "indreOstlandet",
        "Aremark": "ostlandetMedOslo",
        "Arna": "hordaland",
        "Askim": "ostlandetMedOslo",
        "Audnedal": "sorlandet",
        "Aukra": "moreOgRomsdal",
        "Aure": "moreOgRomsdal",
        "Aurland": "sognOgFjordande",
        "Aurskog-Høland": "ostlandetMedOslo",
        "Austevoll": "hordaland",
        "Austrheim": "hordaland",
        "Averøy": "moreOgRomsdal",
        "Balsfjord": "troms",
        "Bamble": "ostlandetMedOslo",
        "Bardu": "troms",
        "Beiarn": "nordland",
        "Bergen": "hordaland",
        "Berlevåg": "finnmark",
        "Bindal": "nordland",
        "Birkenes": "sorlandet",
        "Bjerkreim": "rogaland",
        "Bjugn": "trondelag",
        "Bodø": "nordland",
        "Bokn": "rogaland",
        "Bremanger": "sognOgFjordande",
        "Brønnøy": "nordland",
        "Bygland": "sorlandet",
        "Bykle": "sorlandet",
        "Bærum": "ostlandetMedOslo",
        "Bø": "nordland",
        "Bømlo": "hordaland",
        "Båtsfjord": "finnmark",
        "Dovre": "indreOstlandet",
        "Drammen": "ostlandetMedOslo",
        "Drangedal": "ostlandetMedOslo",
        "Dyrøy": "troms",
        "Dønna": "nordland",
        "Eid": "sognOgFjordande",
        "Eidfjord": "hordaland",
        "Eidsberg": "ostlandetMedOslo",
        "Eidskog": "indreOstlandet",
        "Eidsvoll": "ostlandetMedOslo",
        "Eigersund": "rogaland",
        "Elverum": "indreOstlandet",
        "Enebakk": "ostlandetMedOslo",
        "Engerdal": "indreOstlandet",
        "Etne": "hordaland",
        "Etnedal": "indreOstlandet",
        "Evenes": "nordland",
        "Evje og Hornnes": "sorlandet",
        "Farsund": "sorlandet",
        "Fauske": "nordland",
        "Fedje": "hordaland",
        "Fitjar": "hordaland",
        "Fjaler": "sognOgFjordande",
        "Fjord": "moreOgRomsdal",
        "Flakstad": "nordland",
        "Flatanger": "trondelag",
        "Flekkefjord": "sorlandet",
        "Flora": "sognOgFjordande",
        "Flå": "sentraleFjellstrokISorNorge",
        "Folldal": "indreOstlandet",
        "Forsand": "rogaland",
        "Fosnes": "trondelag",
        "Frogn": "ostlandetMedOslo",
        "Froland": "sorlandet",
        "Frosta": "trondelag",
        "Fræna": "moreOgRomsdal",
        "Frøya": "trondelag",
        "Fyresdal": "sentraleFjellstrokISorNorge",
        "Færder": "ostlandetMedOslo",
        "Gamvik": "finnmark",
        "Gaular": "sognOgFjordande",
        "Gausdal": "indreOstlandet",
        "Gildeskål": "nordland",
        "Giske": "moreOgRomsdal",
        "Gjemnes": "moreOgRomsdal",
        "Gjerdrum": "ostlandetMedOslo",
        "Gjerstad": "sorlandet",
        "Gjesdal": "rogaland",
        "Gjøvik": "indreOstlandet",
        "Gloppen": "sognOgFjordande",
        "Gol": "sentraleFjellstrokISorNorge",
        "Gran": "indreOstlandet",
        "Grane": "nordland",
        "Granvin": "hordaland",
        "Gratangen": "troms",
        "Grimstad": "sorlandet",
        "Grong": "trondelag",
        "Grue": "indreOstlandet",
        "Gulen": "sognOgFjordande",
        "Hadsel": "nordland",
        "Halden": "ostlandetMedOslo",
        "Hamar": "indreOstlandet",
        "Hamarøy": "nordland",
        "Hamble": "ostlandetMedOslo",
        "Hareid": "moreOgRomsdal",
        "Harstad": "troms",
        "Hasvik": "finnmark",
        "Hattfjelldal": "nordland",
        "Haugesund": "rogaland",
        "Hemne": "trondelag",
        "Hemsedal": "sentraleFjellstrokISorNorge",
        "Herøy": "nordland",
        "Hitra": "trondelag",
        "Hjelmeland": "rogaland",
        "Hobøl": "ostlandetMedOslo",
        "Hof": "ostlandetMedOslo",
        "Hol": "sentraleFjellstrokISorNorge",
        "Hole": "ostlandetMedOslo",
        "Holmestrand": "ostlandetMedOslo",
        "Holtålen": "trondelag",
        "Horten": "ostlandetMedOslo",
        "Hurdal": "ostlandetMedOslo",
        "Hustadvika": "moreOgRomsdal",
        "Hvaler": "ostlandetMedOslo",
        "Hyllestad": "sognOgFjordande",
        "Hægebostad": "sorlandet",
        "Høyanger": "sognOgFjordande",
        "Høylandet": "trondelag",
        "Ibestad": "troms",
        "Inderøy": "trondelag",
        "Indre Fosen": "trondelag",
        "Jevnaker": "ostlandetMedOslo",
        "Karasjok": "finnmark",
        "Karmøy": "rogaland",
        "Kautokeino": "finnmark",
        "Kinn": "sognOgFjordande",
        "Klæbu": "trondelag",
        "Klepp": "rogaland",
        "Kongsberg": "ostlandetMedOslo",
        "Kongsvinger": "indreOstlandet",
        "Kragerø": "ostlandetMedOslo",
        "Kristiansand": "sorlandet",
        "Kristiansund": "moreOgRomsdal",
        "Krokstadelva": "ostlandetMedOslo",
        "Kvafjord": "troms",
        "Kvam": "hordaland",
        "Kvinnherad": "hordaland",
        "Kviteseid": "sentraleFjellstrokISorNorge",
        "Kvitsøy": "rogaland",
        "Kvål": "trondelag",
        "Lardal": "ostlandetMedOslo",
        "Langesund": "ostlandetMedOslo",
        "Larvik": "ostlandetMedOslo",
        "Lauvsnes": "trondelag",
        "Lavangen": "troms",
        "Leikanger": "sognOgFjordande",
        "Leirfjord": "nordland",
        "Leka": "trondelag",
        "Leknes": "nordland",
        "Lenvik": "troms",
        "Lesja": "indreOstlandet",
        "Levanger": "trondelag",
        "Lier": "ostlandetMedOslo",
        "Lierne": "trondelag",
        "Lillehammer": "indreOstlandet",
        "Lillesand": "sorlandet",
        "Lindesnes": "sorlandet",
        "Lindås": "hordaland",
        "Lom": "indreOstlandet",
        "Longyearbyen": "Svalbard",
        "Loppa": "finnmark",
        "Lund": "rogaland",
        "Lunner": "ostlandetMedOslo",
        "Lurøy": "nordland",
        "Luster": "sognOgFjordande",
        "Lyngdal": "sorlandet",
        "Lyngen": "troms",
        "Lærdal": "sognOgFjordande",
        "Lødingen": "nordland",
        "Malvik": "trondelag",
        "Mandag": "sorlandet",
        "Marker": "ostlandetMedOslo",
        "Masfjorden": "hordaland",
        "Melhus": "trondelag",
        "Meldal": "trondelag",
        "Meløy": "nordland",
        "Meråker": "trondelag",
        "Midtre Gauldal": "trondelag",
        "Modalen": "hordaland",
        "Modum": "ostlandetMedOslo",
        "Molde": "moreOgRomsdal",
        "Moskenes": "nordland",
        "Moss": "ostlandetMedOslo",
        "Målselv": "troms",
        "Måsøy": "finnmark",
        "Namdalseid": "trondelag",
        "Namsos": "trondelag",
        "Namsskogan": "trondelag",
        "Nannestad": "ostlandetMedOslo",
        "Narvik": "nordland",
        "Nes": "indreOstlandet",
        "Nesbyen": "sentraleFjellstrokISorNorge",
        "Nesodden": "ostlandetMedOslo",
        "Nesseby": "finnmark",
        "Nissedal": "sentraleFjellstrokISorNorge",
        "Nittedal": "ostlandetMedOslo",
        "Nome": "ostlandetMedOslo",
        "Nord-Aurdal": "indreOstlandet",
        "Norddal": "moreOgRomsdal",
        "Nord-Fron": "indreOstlandet",
        "Nordkapp": "finnmark",
        "Nordre Land": "indreOstlandet",
        "Nordreisa": "troms",
        "Nore og Uvdal": "sentraleFjellstrokISorNorge",
        "Notodden": "ostlandetMedOslo",
        "Nærøy": "trondelag",
        "Odda": "hordaland",
        "Oppdal": "trondelag",
        "Oppegård": "ostlandetMedOslo",
        "Orkdal": "trondelag",
        "Os": "hordaland",
        "Osen": "trondelag",
        "Oslo": "ostlandetMedOslo",
        "Osterøy": "hordaland",
        "Overhalla": "trondelag",
        "Porsanger": "finnmark",
        "Porsgrunn": "ostlandetMedOslo",
        "Rakkestad": "ostlandetMedOslo",
        "Rana": "nordland",
        "Randaberg": "rogaland",
        "Rauma": "moreOgRomsdal",
        "Re": "ostlandetMedOslo",
        "Rendalen": "indreOstlandet",
        "Rennebu": "trondelag",
        "Rindal": "trondelag",
        "Ringebu": "indreOstlandet",
        "Ringerike": "ostlandetMedOslo",
        "Ringsaker": "indreOstlandet",
        "Risør": "sorlandet",
        "Roan": "trondelag",
        "Rollag": "sentraleFjellstrokISorNorge",
        "Rygge": "ostlandetMedOslo",
        "Rælingen": "ostlandetMedOslo",
        "Rødøy": "nordland",
        "Rømskog": "ostlandetMedOslo",
        "Røros": "trondelag",
        "Røst": "nordland",
        "Røyken": "ostlandetMedOslo",
        "Røyrvik": "trondelag",
        "Salangen": "troms",
        "Saltdal": "nordland",
        "Samnanger": "hordaland",
        "Sande": "ostlandetMedOslo",
        "Sandefjord": "ostlandetMedOslo",
        "Sandnes": "rogaland",
        "Sandøy": "moreOgRomsdal",
        "Sarpsborg": "ostlandetMedOslo",
        "Sauda": "rogaland",
        "Sel": "indreOstlandet",
        "Selbu": "trondelag",
        "Selje": "sognOgFjordande",
        "Sigdal": "ostlandetMedOslo",
        "Siljan": "ostlandetMedOslo",
        "Sirdal": "sentraleFjellstrokISorNorge",
        "Skaun": "trondelag",
        "Skedsmo": "ostlandetMedOslo",
        "Ski": "ostlandetMedOslo",
        "Skien": "ostlandetMedOslo",
        "Skiptvet": "ostlandetMedOslo",
        "Skjervøy": "troms",
        "Skjåk": "indreOstlandet",
        "Smøla": "moreOgRomsdal",
        "Snillfjord": "trondelag",
        "Snåsa": "trondelag",
        "Sogndal": "sognOgFjordande",
        "Sokndal": "rogaland",
        "Sola": "rogaland",
        "Solund": "sognOgFjordande",
        "Songdalen": "sorlandet",
        "Sortland": "nordland",
        "Spydeberg": "ostlandetMedOslo",
        "Stange": "indreOstlandet",
        "Stavanger": "rogaland",
        "Steigen": "nordland",
        "Steinkjer": "trondelag",
        "Stjørdal": "trondelag",
        "Stokke": "ostlandetMedOslo",
        "Stord": "hordaland",
        "Stordal": "moreOgRomsdal",
        "Stor-Elvdal": "indreOstlandet",
        "Storfjord": "troms",
        "Strand": "rogaland",
        "Stranda": "moreOgRomsdal",
        "Stryn": "sognOgFjordande",
        "Sula": "moreOgRomsdal",
        "Suldal": "rogaland",
        "Sund": "hordaland",
        "Sunndal": "moreOgRomsdal",
        "Surnadal": "moreOgRomsdal",
        "Sveio": "hordaland",
        "Sykkylven": "moreOgRomsdal",
        "Søgne": "sorlandet",
        "Sømna": "nordland",
        "Søndre Land": "indreOstlandet",
        "Sør-Aurdal": "indreOstlandet",
        "Sørfold": "nordland",
        "Sør-Fron": "indreOstlandet",
        "Sør-Odal": "indreOstlandet",
        "Sørreisa": "troms",
        "Sørum": "ostlandetMedOslo",
        "Tana": "finnmark",
        "Time": "rogaland",
        "Tingvoll": "moreOgRomsdal",
        "Tinn": "sentraleFjellstrokISorNorge",
        "Tjeldsund": "nordland",
        "Tokke": "sentraleFjellstrokISorNorge",
        "Tolga": "indreOstlandet",
        "Torsken": "troms",
        "Tranøy": "troms",
        "Trondheim": "trondelag",
        "Trysil": "indreOstlandet",
        "Træna": "nordland",
        "Tvedestrand": "sorlandet",
        "Tydal": "trondelag",
        "Tynset": "indreOstlandet",
        "Tysfjord": "nordland",
        "Tysnes": "hordaland",
        "Tysvær": "rogaland",
        "Tønsberg": "ostlandetMedOslo",
        "Ullensaker": "ostlandetMedOslo",
        "Ullensvang": "hordaland",
        "Ulstein": "moreOgRomsdal",
        "Ulvik": "hordaland",
        "Utsira": "rogaland",
        "Vadsø": "finnmark",
        "Vaksdal": "hordaland",
        "Vang": "indreOstlandet",
        "Vanylven": "moreOgRomsdal",
        "Vardø": "finnmark",
        "Vefsn": "nordland",
        "Vega": "nordland",
        "Vegårshei": "sorlandet",
        "Vennesla": "sorlandet",
        "Verdal": "trondelag",
        "Vestby": "ostlandetMedOslo",
        "Vestnes": "moreOgRomsdal",
        "Vestre Slidre": "indreOstlandet",
        "Vestre Toten": "indreOstlandet",
        "Vestvågøy": "nordland",
        "Vevelstad": "nordland",
        "Vik": "sognOgFjordande",
        "Vindafjord": "rogaland",
        "Vinje": "sentraleFjellstrokISorNorge",
        "Volda": "moreOgRomsdal",
        "Voss": "hordaland",
        "Værøy": "nordland",
        "Vågan": "nordland",
        "Vågsøy": "sognOgFjordande",
        "Vågå": "indreOstlandet",
        "Øksnes": "nordland",
        "Ørland": "trondelag",
        "Ørskog": "moreOgRomsdal",
        "Ørsta": "moreOgRomsdal",
        "Østre Toten": "indreOstlandet",
        "Øvre Eiker": "ostlandetMedOslo",
        "Øyer": "indreOstlandet",
        "Øygarden": "hordaland",
        "Øystre Slidre": "indreOstlandet",
        "Åfjord": "trondelag",
        "Ål": "sentraleFjellstrokISorNorge",
        "Ålesund": "moreOgRomsdal",
        "Åmli": "sorlandet",
        "Åmot": "indreOstlandet",
        "Årdal": "sognOgFjordande",
        "Ås": "ostlandetMedOslo",
        "Åseral": "sorlandet",
        "Åsnes": "indreOstlandet"
    }